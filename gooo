local Players = game:GetService("Players")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

local AUTO_WEAVE_ENABLED = true -- Toggle for AutoWeave (CG_AutoWeave = true)
local LEGIT_MODE = true -- Legit mode for natural behavior (CG_AutoWeave_LegitMode = true)
local ACTIVATION_DELAY = 0.005 -- Delay in seconds (CG_AutoWeave_ActivationDelay = 0.005)
local TOGGLE_KEY = Enum.KeyCode.T -- Toggle key (CG_AutoWeave_K = "T")
local isWeaving = AUTO_WEAVE_ENABLED

-- Function to perform dodge without moving
local function performWeave()
    if not isWeaving or not Humanoid or Humanoid.Health <= 0 then
        return
    end

    -- Store current position to restore after dodge
    local originalCFrame = RootPart.CFrame

    if LEGIT_MODE then
        -- Simulate dodge by briefly changing Humanoid state to Physics
        Humanoid:ChangeState(Enum.HumanoidStateType.Physics)
        wait(0.1) -- Brief duration to disrupt hit registration
        if Humanoid.Health > 0 then
            Humanoid:ChangeState(Enum.HumanoidStateType.Running) -- Restore normal state
        end
    else
        -- Non-legit mode: Temporarily disable collision
        RootPart.CanCollide = false
        wait(0.1)
        RootPart.CanCollide = true
    end

    -- Restore original position to ensure no movement
    RootPart.CFrame = originalCFrame

    -- Small delay to prevent spam
    wait(ACTIVATION_DELAY)
end

-- Detect punch via health change
local lastHealth = Humanoid.Health
Humanoid.HealthChanged:Connect(function(newHealth)
    if newHealth < lastHealth and isWeaving then
        performWeave()
    end
    lastHealth = newHealth
end)

-- Detect punch via humanoid state (e.g., hitstun)
Humanoid.StateChanged:Connect(function(oldState, newState)
    if isWeaving and newState == Enum.HumanoidStateType.GettingUp then
        performWeave()
    end
end)

-- Toggle AutoWeave with keybind
game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end
    if input.KeyCode == TOGGLE_KEY then
        isWeaving = not isWeaving
        print("AutoWeave " .. (isWeaving and "enabled" or "disabled"))
    end
end)

-- Handle character respawn
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = Character:WaitForChild("Humanoid")
    RootPart = Character:WaitForChild("HumanoidRootPart")
    lastHealth = Humanoid.Health
end)
